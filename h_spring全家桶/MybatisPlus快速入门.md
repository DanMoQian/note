# MybatisPlus

## ç®€ä»‹

[MyBatis-Plus (opens new window)](https://github.com/baomidou/mybatis-plus)ï¼ˆç®€ç§° MPï¼‰æ˜¯ä¸€ä¸ª [MyBatis (opens new window)](http://www.mybatis.org/mybatis-3/)çš„å¢å¼ºå·¥å…·ï¼Œåœ¨ MyBatis çš„åŸºç¡€ä¸Šåªåšå¢å¼ºä¸åšæ”¹å˜ï¼Œä¸ºç®€åŒ–å¼€å‘ã€æé«˜æ•ˆç‡è€Œç”Ÿã€‚

## ç‰¹æ€§

- **æ— ä¾µå…¥**ï¼šåªåšå¢å¼ºä¸åšæ”¹å˜ï¼Œå¼•å…¥å®ƒä¸ä¼šå¯¹ç°æœ‰å·¥ç¨‹äº§ç”Ÿå½±å“ï¼Œå¦‚ä¸èˆ¬é¡ºæ»‘
- **æŸè€—å°**ï¼šå¯åŠ¨å³ä¼šè‡ªåŠ¨æ³¨å…¥åŸºæœ¬ CURDï¼Œæ€§èƒ½åŸºæœ¬æ— æŸè€—ï¼Œç›´æ¥é¢å‘å¯¹è±¡æ“ä½œ
- **å¼ºå¤§çš„ CRUD æ“ä½œ**ï¼šå†…ç½®é€šç”¨ Mapperã€é€šç”¨ Serviceï¼Œä»…ä»…é€šè¿‡å°‘é‡é…ç½®å³å¯å®ç°å•è¡¨å¤§éƒ¨åˆ† CRUD æ“ä½œï¼Œæ›´æœ‰å¼ºå¤§çš„æ¡ä»¶æ„é€ å™¨ï¼Œæ»¡è¶³å„ç±»ä½¿ç”¨éœ€æ±‚
- **æ”¯æŒ Lambda å½¢å¼è°ƒç”¨**ï¼šé€šè¿‡ Lambda è¡¨è¾¾å¼ï¼Œæ–¹ä¾¿çš„ç¼–å†™å„ç±»æŸ¥è¯¢æ¡ä»¶ï¼Œæ— éœ€å†æ‹…å¿ƒå­—æ®µå†™é”™
- **æ”¯æŒä¸»é”®è‡ªåŠ¨ç”Ÿæˆ**ï¼šæ”¯æŒå¤šè¾¾ 4 ç§ä¸»é”®ç­–ç•¥ï¼ˆå†…å«åˆ†å¸ƒå¼å”¯ä¸€ ID ç”Ÿæˆå™¨ - Sequenceï¼‰ï¼Œå¯è‡ªç”±é…ç½®ï¼Œå®Œç¾è§£å†³ä¸»é”®é—®é¢˜
- **æ”¯æŒ ActiveRecord æ¨¡å¼**ï¼šæ”¯æŒ ActiveRecord å½¢å¼è°ƒç”¨ï¼Œå®ä½“ç±»åªéœ€ç»§æ‰¿ Model ç±»å³å¯è¿›è¡Œå¼ºå¤§çš„ CRUD æ“ä½œ
- **æ”¯æŒè‡ªå®šä¹‰å…¨å±€é€šç”¨æ“ä½œ**ï¼šæ”¯æŒå…¨å±€é€šç”¨æ–¹æ³•æ³¨å…¥ï¼ˆ Write once, use anywhere ï¼‰
- **å†…ç½®ä»£ç ç”Ÿæˆå™¨**ï¼šé‡‡ç”¨ä»£ç æˆ–è€… Maven æ’ä»¶å¯å¿«é€Ÿç”Ÿæˆ Mapper ã€ Model ã€ Service ã€ Controller å±‚ä»£ç ï¼Œæ”¯æŒæ¨¡æ¿å¼•æ“ï¼Œæ›´æœ‰è¶…å¤šè‡ªå®šä¹‰é…ç½®ç­‰æ‚¨æ¥ä½¿ç”¨
- **å†…ç½®åˆ†é¡µæ’ä»¶**ï¼šåŸºäº MyBatis ç‰©ç†åˆ†é¡µï¼Œå¼€å‘è€…æ— éœ€å…³å¿ƒå…·ä½“æ“ä½œï¼Œé…ç½®å¥½æ’ä»¶ä¹‹åï¼Œå†™åˆ†é¡µç­‰åŒäºæ™®é€š List æŸ¥è¯¢
- **åˆ†é¡µæ’ä»¶æ”¯æŒå¤šç§æ•°æ®åº“**ï¼šæ”¯æŒ MySQLã€MariaDBã€Oracleã€DB2ã€H2ã€HSQLã€SQLiteã€Postgreã€SQLServer ç­‰å¤šç§æ•°æ®åº“
- **å†…ç½®æ€§èƒ½åˆ†ææ’ä»¶**ï¼šå¯è¾“å‡º Sql è¯­å¥ä»¥åŠå…¶æ‰§è¡Œæ—¶é—´ï¼Œå»ºè®®å¼€å‘æµ‹è¯•æ—¶å¯ç”¨è¯¥åŠŸèƒ½ï¼Œèƒ½å¿«é€Ÿæªå‡ºæ…¢æŸ¥è¯¢
- **å†…ç½®å…¨å±€æ‹¦æˆªæ’ä»¶**ï¼šæä¾›å…¨è¡¨ delete ã€ update æ“ä½œæ™ºèƒ½åˆ†æé˜»æ–­ï¼Œä¹Ÿå¯è‡ªå®šä¹‰æ‹¦æˆªè§„åˆ™ï¼Œé¢„é˜²è¯¯æ“ä½œ

## å¿«é€Ÿå…¥é—¨

åœ°å€ï¼šhttps://baomidou.com/guide/quick-start.html

ä½¿ç”¨ç¬¬ä¸‰æ–¹ç»„ä»¶

1. å¯¼å…¥å¯¹åº”çš„ä¾èµ–
2. ç ”ç©¶ä¾èµ–å¦‚ä½•é…ç½®
3. ä»£ç å¦‚ä½•ç¼–å†™
4. æé«˜æ‰©å±•æŠ€æœ¯èƒ½åŠ›

==è¿™æ˜¯3.4.1ç‰ˆæœ¬çš„ä¸ä½ç‰ˆæœ¬æœ‰æ‰€åŒºåˆ«==

> æ­¥éª¤

1. åˆ›å»ºæ•°æ®åº“  ==mybatis_plus==

2. åˆ›å»º==user==è¡¨

   ```sql
   DROP TABLE IF EXISTS user;
   
   CREATE TABLE user
   (
   	id BIGINT(20) NOT NULL COMMENT 'ä¸»é”®ID',
   	name VARCHAR(30) NULL DEFAULT NULL COMMENT 'å§“å',
   	age INT(11) NULL DEFAULT NULL COMMENT 'å¹´é¾„',
   	email VARCHAR(50) NULL DEFAULT NULL COMMENT 'é‚®ç®±',
   	PRIMARY KEY (id)
   );
   #çœŸå®å¼€å‘ä¸­ï¼Œversion(ä¹è§‚é”)ã€deleted(é€»è¾‘åˆ é™¤)ã€gmt_create/gmt_modified
   ```


3. åˆå§‹åŒ–å·¥ç¨‹ `springboot`

   æ·»åŠ ä¾èµ–

   ```xml
   <dependencies>
       <dependency>
           <groupId>org.springframework.boot</groupId>
           <artifactId>spring-boot-starter</artifactId>
       </dependency>
       <dependency>
           <groupId>org.springframework.boot</groupId>
           <artifactId>spring-boot-starter-test</artifactId>
           <scope>test</scope>
       </dependency>
       <dependency>
           <groupId>org.projectlombok</groupId>
           <artifactId>lombok</artifactId>
           <optional>true</optional>
       </dependency>
       <dependency>
           <groupId>com.baomidou</groupId>
           <artifactId>mybatis-plus-boot-starter</artifactId>
           <version>3.4.1</version>
       </dependency>
   </dependencies>
   ```

4.  é…ç½®

   åœ¨ `application.yml` é…ç½®æ–‡ä»¶ä¸­æ·»åŠ  mysqlçš„ç›¸å…³é…ç½®ï¼š

   ```yml
   spring:
     datasource:
       driver-class-name: com.mysql.cj.jdbc.Driver
       #mysql8 è¦å†™æ—¶åŒº
       url: jdbc:mysql://localhost:3306/springboot?serverTimezone=Asia/Shanghai&useUnicode=true&characterEncoding=utf-8
       username: root
       passwor: root
   ```

5. åœ¨ Spring Boot å¯åŠ¨ç±»ä¸­æ·»åŠ  `@MapperScan` æ³¨è§£ï¼Œæ‰«æ Mapper æ–‡ä»¶å¤¹ï¼š

   ```java
   @SpringBootApplication
   //æ³¨æ„åªå†™åˆ°mapperåŒ…ä¸€çº§å°±å¯ä»¥äº†ï¼Œä¸è¦å†™åˆ°å­åŒ…
   @MapperScan("com.mycode.mapper")
   public class MybatisPlusApplication {
   
       public static void main(String[] args) {
           SpringApplication.run(MybatisPlusApplication.class, args);
       }
   
   }
   ```

6. ç¼–å†™pojoç±»

   ```java
   @Data
   @NoArgsConstructor
   @AllArgsConstructor
   public class User {
   
       //private Integer id;
       private Long id;//é‡‡å‘ï¼šæ•°æ®åº“ç”¨çš„æ˜¯BigIntè¦ä½¿ç”¨Longæ‰è¡Œï¼ï¼ï¼
       private String name;
       private Integer age;
       private String email;
   
   }
   ```

7. ç¼–å†™mapperç±»

   ```java
   @Repository
   public interface UserMapper extends BaseMapper<User> {
   }
   ```

8. ç¼–å†™æµ‹è¯•ç±»

   ```java
   @SpringBootTest
   class MybatisPlusApplicationTests {
   
       @Autowired
       private UserMapper userMapper;
   
       @Test
       void contextLoads() {
           List<User> users = userMapper.selectList(null);
           users.forEach(System.out::println);
       }
   
   }
   ```

9. ==ç»“æœ==

   ![image-20201216234905499](https://gitee.com/danmoqi/pictureBed/raw/master/img/image-20201216234905499.png)



## é…ç½®æ—¥å¿—

åœ¨application.ymlä¸­æ·»åŠ ä¸€æ¡é…ç½®

```yml
mybatis-plus:
  configuration:
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl
```

`ç»“æœ`

![image-20201217000237861](https://gitee.com/danmoqi/pictureBed/raw/master/img/image-20201217000237861.png)

## CURD

### insert

- ä¸»é”®ç”Ÿæˆç­–ç•¥

#### [](https://baomidou.com/guide/annotation.html#idtype)[@IdType(opens new window)](https://github.com/baomidou/mybatis-plus/blob/3.0/mybatis-plus-annotation/src/main/java/com/baomidou/mybatisplus/annotation/IdType.java)

|      å€¼       |                             æè¿°                             |
| :-----------: | :----------------------------------------------------------: |
|    `AUTO`     |            æ•°æ®åº“IDè‡ªå¢==æ•°æ®åº“è¡¨å¿…é¡»è®¾ç½®è‡ªå¢é•¿==            |
|     NONE      | æ— çŠ¶æ€,è¯¥ç±»å‹ä¸ºæœªè®¾ç½®ä¸»é”®ç±»å‹(æ³¨è§£é‡Œç­‰äºè·Ÿéšå…¨å±€,å…¨å±€é‡Œçº¦ç­‰äº INPUT) |
|     INPUT     |                    insertå‰è‡ªè¡Œsetä¸»é”®å€¼                     |
|  `ASSIGN_ID`  | åˆ†é…ID(ä¸»é”®ç±»å‹ä¸ºNumber(Longå’ŒInteger)æˆ–String)(since 3.3.0),ä½¿ç”¨æ¥å£`IdentifierGenerator`çš„æ–¹æ³•`nextId`(é»˜è®¤å®ç°ç±»ä¸º`DefaultIdentifierGenerator`é›ªèŠ±ç®—æ³•) |
|  ASSIGN_UUID  | åˆ†é…UUID,ä¸»é”®ç±»å‹ä¸ºString(since 3.3.0),ä½¿ç”¨æ¥å£`IdentifierGenerator`çš„æ–¹æ³•`nextUUID`(é»˜è®¤defaultæ–¹æ³•) |
|   ID_WORKER   |     åˆ†å¸ƒå¼å…¨å±€å”¯ä¸€ID é•¿æ•´å‹ç±»å‹(please use `ASSIGN_ID`)      |
|     UUID      |           32ä½UUIDå­—ç¬¦ä¸²(please use `ASSIGN_UUID`)           |
| ID_WORKER_STR |     åˆ†å¸ƒå¼å…¨å±€å”¯ä¸€ID å­—ç¬¦ä¸²ç±»å‹(please use `ASSIGN_ID`)      |

```java
@Data
@NoArgsConstructor
@AllArgsConstructor
public class User {

    @TableId(type = IdType.ASSIGN_ID)
    private Long id;
    private String name;
    private Integer age;
    private String email;

}
```

```java
@Test
void contextLoads() {
    User user = new User();
    user.setName("å¼ ä¸‰");
    user.setAge(20);
    user.setEmail("zhangsan@gmail.com");
    int insert = userMapper.insert(user);
    System.out.println(insert);
}
```

### update

```java
@Test
public void updateTest(){
    User user = new User();
    user.setId(5L);
    user.setName("å¼ ä¸‰");
    user.setAge(1);
    user.setEmail("zhangsan@gmail.com");
    userMapper.updateById(user);
}
```

#### è‡ªåŠ¨å¡«å……

åˆ›å»ºæ—¶é—´ã€ä¿®æ”¹æ—¶é—´ï¼è‡ªåŠ¨å®Œæˆã€ä¸è¦æ‰‹åŠ¨æ›´æ–°ã€‚ `gmt_create`ã€`gmt_modified`å‡ ä¹æ‰€æœ‰çš„è¡¨éƒ½è¦é…ç½®ä¸Š

> æ–¹å¼ä¸€ï¼šæ•°æ®åº“çº§åˆ«

æ–°å¢ä¸¤ä¸ªå­—æ®µ`gmt_create`ã€`gmt_modified`

![image-20201217133632411](https://gitee.com/danmoqi/pictureBed/raw/master/img/image-20201217133632411.png)

```java
@Test
public void updateTest(){
    User user = new User();
    user.setId(5L);
    user.setName("å¼ ä¸‰");
    user.setAge(278);
    user.setEmail("zhangsan@gmail.com");
    userMapper.updateById(user);
}
```

![image-20201217134403330](https://gitee.com/danmoqi/pictureBed/raw/master/img/image-20201217134403330.png)

==å‘ï¼šå¤šæ¬¡æ‰§è¡Œè¯¥ä»£ç ä¸ä¼šæ‰§è¡Œæ—¶é—´æˆ³æ›´æ–° å…·ä½“åŸå› ä¸æ¸…æ¥š==

> æ–¹å¼äºŒï¼šä»£ç çº§åˆ«

==æ–¹æ³•ä¸€ä¸æ¨èä½¿ç”¨==

ä½¿ç”¨æ³¨è§£

```java
//å­—æ®µæ·»åŠ å¡«å……å†…å®¹ 
@TableField(fill = FieldFill.INSERT)//åœ¨æ’å…¥çš„æ—¶å€™å¡«å……
private Date gmtCreate;
@TableField(fill = FieldFill.INSERT_UPDATE)//åœ¨æ’å…¥å’Œæ›´æ–°çš„çš„æ—¶å€™å¡«å……
private Date gmtModified;
```

```java
@Slf4j
@Component //ä¸€å®šè¦æŠŠå¤„ç†å™¨æ”¾åˆ°IOCå®¹å™¨ä¸­
public class MeMetaObjectHandler implements MetaObjectHandler {

    //æ’å…¥æ—¶çš„å¡«å……ç­–ç•¥
    @Override
    public void insertFill(MetaObject metaObject) {
      log.info("start insert fill");
      this.setFieldValByName("gmtCreate", new Date(), metaObject);
      this.setFieldValByName("gmtModified", new Date(), metaObject);
    }

    //æ›´æ–°æ—¶çš„å¡«å……æ•°æ®
    @Override
    public void updateFill(MetaObject metaObject) {
        this.setFieldValByName("gmtModified", new Date(), metaObject);
    }
}
```

æ‰§è¡Œæ’å…¥å’Œæ›´æ–°æ“ä½œä¹‹åï¼š

![image-20201217144727998](https://gitee.com/danmoqi/pictureBed/raw/master/img/image-20201217144727998.png)

#### ä¹è§‚é”

> ä¹è§‚é”ï¼šå¼€æ”¾ï¼Œä¸ä¼šå‡ºç°é—®é¢˜ï¼Œå‡ºç°é—®é¢˜å†æ¬¡æ›´æ–°å€¼
>
> æ‚²è§‚é”ï¼šæ‚²è§‚ï¼Œéƒ½è¦ä¸Šé”ï¼Œå†å»æ“ä½œ

ä¹è§‚é”

- å–å‡ºè®°å½•æ—¶ï¼Œè·å–å½“å‰version
- æ›´æ–°æ—¶ï¼Œå¸¦ä¸Šversion
- æ‰§è¡Œæ›´æ–°æ—¶ï¼Œset version = newVersion where version = version + 1

- å¦‚æœversionä¸å¯¹ï¼Œå°±æ›´æ–°å¤±è´¥

```mysql
-- åˆå§‹versionä¸º1
update user set name=â€˜zhangsanâ€™,version = version + 1
where id = 1 and version = 1;
```

> å®ç°ä¹è§‚é”

1. ä¿®æ”¹è¡¨åŠå…¶å®ä½“ç±» æ·»åŠ versionå­—æ®µ

![image-20201217151356501](https://gitee.com/danmoqi/pictureBed/raw/master/img/image-20201217151356501.png)

```java
@Data
@NoArgsConstructor
@AllArgsConstructor
public class User {

    @TableId(type = IdType.ASSIGN_ID)
    private Long id;
    private String name;
    private Integer age;
    private String email;
    @TableField(fill = FieldFill.INSERT)
    private Date gmtCreate;
    @TableField(fill = FieldFill.INSERT_UPDATE)
    private Date gmtModified;
    
    
    @Version
    private Integer version;//æ·»åŠ çš„versionå­—æ®µ
}
```

2. é…ç½®ä¹è§‚é”ç±»

```java

//æ›´æ–°æ–°ç‰ˆåº”è¯¥è¿™æ ·ä½¿ç”¨
@Configuration
@MapperScan("com.mycode.mapper")
@EnableTransactionManagement
public class MyBatisPlusConfig {

    /**
     * ä¹è§‚é”
     * éœ€è¦è®¾ç½® MybatisConfiguration#useDeprecatedExecutor = false é¿å…ç¼“å­˜å‡ºç°é—®é¢˜(è¯¥å±æ€§ä¼šåœ¨æ—§æ’ä»¶ç§»é™¤åä¸€åŒç§»é™¤)
     */
    @Bean
    public MybatisPlusInterceptor mybatisPlusInterceptor(){
        MybatisPlusInterceptor interceptor = new MybatisPlusInterceptor();
        //ä¹è§‚é”æ’ä»¶é…ç½®
        interceptor.addInnerInterceptor(new OptimisticLockerInnerInterceptor());
        return interceptor;
    }

    @Bean
    public ConfigurationCustomizer configurationCustomizer() {
        return configuration -> configuration.setUseDeprecatedExecutor(false);
    }

}

/*@Configuration
@MapperScan("com.mycode.mapper")
@EnableTransactionManagement
public class MyBatisPlusConfig {
	//OptimisticLockerInterceptor æ³¨æ„è¿™æ˜¯ä¸€ä¸ªè¿‡æ—¶ç±»ä½†æ˜¯ç”¨æ–°çš„ä¼šæŠ¥é”™ï¼Œæš‚æ—¶å…ˆç”¨æ—§çš„
    @Bean
    public OptimisticLockerInterceptor optimisticLockerInterceptor(){
        return new OptimisticLockerInterceptor();
    }
}*/

/*
è¿™ç§ç”¨æ³•æ˜¯é”™è¯¯çš„
@Configuration
@MapperScan("com.mycode.mapper")
@EnableTransactionManagement
public class MyBatisPlusConfig {

    @Bean
    public OptimisticLockerInnerInterceptor optimisticLockerInterceptor(){
        return new OptimisticLockerInnerInterceptor();
    }
}*/
```

æ‰§è¡Œæµ‹è¯•ï¼š

```
@Test
public void OptimisticLockerTest(){
    User user = userMapper.selectById(1339461711110885377L);
    System.out.println(user);
    user.setName("ç‹éº»å­");
    user.setAge(53);
    userMapper.updateById(user);
}
```

==æ³¨æ„ï¼šå¿…é¡»å…ˆæŸ¥è¯¢å†æ›´æ–°æ‰èƒ½ä½¿ç”¨ä¹è§‚é”ï¼Œç›´æ¥æ›´æ–°æ˜¯ä¸ä¼šä½¿ç”¨ä¹è§‚é”==

![image-20201217155056770](https://gitee.com/danmoqi/pictureBed/raw/master/img/image-20201217155056770.png)

å¤šçº¿ç¨‹æµ‹è¯•ï¼š

```java
@Test
public void OptimisticLockerTest2(){
    //æ¨¡æ‹Ÿå¤šçº¿ç¨‹
    //ç¬¬ä¸€ä¸ªçº¿ç¨‹å…ˆæŸ¥è¯¢
    User user = userMapper.selectById(1339461711110885377L);
    System.out.println(user);
    user.setName("ç‹éº»å­");
    user.setAge(53);
    //ç¬¬äºŒä¸ªå¤šçº¿ç¨‹å†æ‰§è¡ŒæŸ¥è¯¢å¹¶å…ˆæ›´æ–°
    User user2 = userMapper.selectById(1339461711110885377L);
    System.out.println(user2);
    user2.setName("ç‹éº»å­å¤§çˆ·");
    user2.setAge(99);
    userMapper.updateById(user2);
    //æœ€åæ›´æ–°ç¬¬ä¸€ä¸ªçº¿ç¨‹ä¼šå¤±è´¥
    //å¯ä»¥ä½¿ç”¨è‡ªæ—‹é”
    userMapper.updateById(user);
}
```

![image-20201217155620988](https://gitee.com/danmoqi/pictureBed/raw/master/img/image-20201217155620988.png)

### select

```java
//æ‰¹é‡æŸ¥è¯¢
@Test
public void selectTest(){
    List<User> users = userMapper.selectBatchIds(Arrays.asList(1, 2, 3, 4));
    users.forEach(System.out::println);
}
```

```
//æ¡ä»¶æŸ¥è¯¢
@Test
public void selectByMap(){
    Map<String, Object> map = new HashMap<>();
    map.put("name", "jack");
    List<User> users = userMapper.selectByMap(map);
    System.out.println(users);
}
```

#### åˆ†é¡µæŸ¥è¯¢

å†…ç½®åˆ†é¡µæ’ä»¶

1. é…ç½®

```java
@Bean
    public MybatisPlusInterceptor mybatisPlusInterceptor(){
        MybatisPlusInterceptor interceptor = new MybatisPlusInterceptor();
        //ä¹è§‚é”
        interceptor.addInnerInterceptor(new OptimisticLockerInnerInterceptor());
        //åˆ†é¡µæ’ä»¶
        interceptor.addInnerInterceptor(new PaginationInnerInterceptor());
        //......ç›´æ¥åœ¨è¿™é‡Œé¢newå¯¹åº”çš„æ’ä»¶
        
        return interceptor;
    }
```

æ’ä»¶

- è‡ªåŠ¨åˆ†é¡µ: PaginationInnerInterceptor
- å¤šç§Ÿæˆ·: TenantLineInnerInterceptor
- åŠ¨æ€è¡¨å: DynamicTableNameInnerInterceptor
- ä¹è§‚é”: OptimisticLockerInnerInterceptor
- sqlæ€§èƒ½è§„èŒƒ: IllegalSQLInnerInterceptor
- é˜²æ­¢å…¨è¡¨æ›´æ–°ä¸åˆ é™¤: BlockAttackInnerInterceptor

2. æµ‹è¯•

```java
//åˆ†é¡µæŸ¥è¯¢
@Test
public void pageTest(){
    Page<User> page = new Page<>(2, 5);//å‚æ•°ä¸€ å½“å‰é¡µ å‚æ•°äºŒ é¡µé¢å¤§å°
    userMapper.selectPage(page, null);
    page.getRecords().forEach(System.out::println);
}
```



![image-20201217164547310](https://gitee.com/danmoqi/pictureBed/raw/master/img/image-20201217164547310.png)

### delete

.......

### é€»è¾‘åˆ é™¤

1. ä¿®æ”¹è¡¨å’Œå®ä½“ç±»

![image-20201217170542106](https://gitee.com/danmoqi/pictureBed/raw/master/img/image-20201217170542106.png)

```java
@TableLogic//é€»è¾‘åˆ é™¤
private Integer deleted;
```

2. æ·»åŠ é…ç½®

```yml
global-config:
  db-config:
    logic-delete-field: 1
    logic-not-delete-value: 0
```

3. æµ‹è¯•

```java
//é€»è¾‘åˆ é™¤
@Test
public void deletedByLogic(){
    userMapper.deleteById(1L);
    userMapper.selectById(1L);
}
```

![image-20201217171230708](https://gitee.com/danmoqi/pictureBed/raw/master/img/image-20201217171230708.png)



## æ€§èƒ½åˆ†ææ’ä»¶

æ—¥å¸¸å¼€å‘ä¸­ï¼Œä¼šé‡åˆ°æ…¢sqlã€‚ é€šè¿‡æµ‹è¯•ï¼Œdruid....

mpæ‰§è¡Œ SQL åˆ†ææ‰“å°

ğŸ‘‰ [mybatis-plus-sample-crud(opens new window)](https://gitee.com/baomidou/mybatis-plus-samples/tree/master/mybatis-plus-sample-crud)

- p6spy ä¾èµ–å¼•å…¥

```xml
<!-- p6spy -->
<dependency>
    <groupId>p6spy</groupId>
    <artifactId>p6spy</artifactId>
    <version>3.9.1</version>
</dependency>
```

- ä¿®æ”¹é…ç½®æ–‡ä»¶

```yml
spring:
  datasource:
  #ä¿®æ”¹
    #driver-class-name: com.mysql.cj.jdbc.Driver
    driver-class-name: com.p6spy.engine.spy.P6SpyDriver
    #mysql8 è¦å†™æ—¶åŒº
    #url: jdbc:mysql://localhost:3306/mybatis_plus?serverTimezone=Asia/Shanghai&useUnicode=true&characterEncoding=utf-8
    url: jdbc:p6spy:mysql://localhost:3306/mybatis_plus?serverTimezone=Asia/Shanghai&useUnicode=true&characterEncoding=utf-8
    username: root
    password: root
```

```properties
#p6spy
#3.2.1ä»¥ä¸Šä½¿ç”¨
modulelist=com.baomidou.mybatisplus.extension.p6spy.MybatisPlusLogFactory,com.p6spy.engine.outage.P6OutageFactory
#3.2.1ä»¥ä¸‹ä½¿ç”¨æˆ–è€…ä¸é…ç½®
#modulelist=com.p6spy.engine.logging.P6LogFactory,com.p6spy.engine.outage.P6OutageFactory
# è‡ªå®šä¹‰æ—¥å¿—æ‰“å°
logMessageFormat=com.baomidou.mybatisplus.extension.p6spy.P6SpyLogger
#æ—¥å¿—è¾“å‡ºåˆ°æ§åˆ¶å°
appender=com.baomidou.mybatisplus.extension.p6spy.StdoutLogger
# ä½¿ç”¨æ—¥å¿—ç³»ç»Ÿè®°å½• sql
#appender=com.p6spy.engine.spy.appender.Slf4JLogger
# è®¾ç½® p6spy driver ä»£ç†
deregisterdrivers=true
# å–æ¶ˆJDBC URLå‰ç¼€
useprefix=true
# é…ç½®è®°å½• Log ä¾‹å¤–,å¯å»æ‰çš„ç»“æœé›†æœ‰error,info,batch,debug,statement,commit,rollback,result,resultset.
excludecategories=info,debug,result,commit,resultset
# æ—¥æœŸæ ¼å¼
dateformat=yyyy-MM-dd HH:mm:ss
# å®é™…é©±åŠ¨å¯å¤šä¸ª
#driverlist=org.h2.Driver
# æ˜¯å¦å¼€å¯æ…¢SQLè®°å½•
outagedetection=true
# æ…¢SQLè®°å½•æ ‡å‡† 2 ç§’
outagedetectioninterval=2
```

## æ¡ä»¶æ„é€ å™¨

æ–‡æ¡£ï¼šhttps://baomidou.com/guide/wrapper.html#and



```java
@Autowired
private UserMapper userMapper;

@Test
public void test1(){
    QueryWrapper<User> userWrapper = new QueryWrapper<>();
    userWrapper.eq("name", "å¼ ä¸‰");
    List<User> users = userMapper.selectList(userWrapper);
    System.out.println(users);
}

@Test
public void test2(){
    QueryWrapper<User> userQueryWrapper = new QueryWrapper<>();
    userQueryWrapper.inSql("id", "select id from user where id < 3");
    List<User> userList = userMapper.selectList(userQueryWrapper);
    userList.forEach(System.out::println);
}

@Test
public void test3(){
    QueryWrapper<User> userQueryWrapper = new QueryWrapper<>();
    userQueryWrapper.and(i->i.eq("name", "å¼ ä¸‰").eq("age", 278));
    List<User> userList = userMapper.selectList(userQueryWrapper);
    userList.forEach(System.out::println);
}
```

## ä»£ç è‡ªåŠ¨ç”Ÿæˆå™¨

- ä¾èµ–

```xml
<!--ä»£ç ç”Ÿæˆå™¨-->
<dependency>
    <groupId>com.baomidou</groupId>
    <artifactId>mybatis-plus-generator</artifactId>
    <version>3.4.1</version>
</dependency>
<dependency>
    <groupId>org.freemarker</groupId>
    <artifactId>freemarker</artifactId>
    <version>2.3.28</version>
    <scope>compile</scope>
</dependency>
```

- æ‰§è¡Œç±»

```java
package com.mycode;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.core.exceptions.MybatisPlusException;
import com.baomidou.mybatisplus.core.toolkit.StringPool;
import com.baomidou.mybatisplus.core.toolkit.StringUtils;
import com.baomidou.mybatisplus.generator.AutoGenerator;
import com.baomidou.mybatisplus.generator.InjectionConfig;
import com.baomidou.mybatisplus.generator.config.*;
import com.baomidou.mybatisplus.generator.config.po.TableInfo;
import com.baomidou.mybatisplus.generator.config.rules.NamingStrategy;
import com.baomidou.mybatisplus.generator.engine.FreemarkerTemplateEngine;

import java.util.ArrayList;
import java.util.List;
import java.util.Scanner;

// æ¼”ç¤ºä¾‹å­ï¼Œæ‰§è¡Œ main æ–¹æ³•æ§åˆ¶å°è¾“å…¥æ¨¡å—è¡¨åå›è½¦è‡ªåŠ¨ç”Ÿæˆå¯¹åº”é¡¹ç›®ç›®å½•ä¸­
public class CodeGenerator {

    /**
     * <p>
     * è¯»å–æ§åˆ¶å°å†…å®¹
     * </p>
     */
    public static String scanner(String tip) {
        Scanner scanner = new Scanner(System.in);
        StringBuilder help = new StringBuilder();
        help.append("è¯·è¾“å…¥" + tip + "ï¼š");
        System.out.println(help.toString());
        if (scanner.hasNext()) {
            String ipt = scanner.next();
            if (StringUtils.isNotBlank(ipt)) {
                return ipt;
            }
        }
        throw new MybatisPlusException("è¯·è¾“å…¥æ­£ç¡®çš„" + tip + "ï¼");
    }

    public static void main(String[] args) {
        // ä»£ç ç”Ÿæˆå™¨
        AutoGenerator mpg = new AutoGenerator();

        // å…¨å±€é…ç½®
        GlobalConfig gc = new GlobalConfig();
        String projectPath = System.getProperty("user.dir");
        gc.setOutputDir(projectPath + "/src/main/java");
        gc.setAuthor("DMQi");
        gc.setOpen(false);
        gc.setSwagger2(true); //å®ä½“å±æ€§ Swagger2 æ³¨è§£
        mpg.setGlobalConfig(gc);

        // æ•°æ®æºé…ç½®
        DataSourceConfig dsc = new DataSourceConfig();
        dsc.setUrl("jdbc:mysql://localhost:3306/vhr?serverTimezone=Asia/Shanghai&useUnicode=true&characterEncoding=utf-8");
        // dsc.setSchemaName("public");
        dsc.setDriverName("com.mysql.cj.jdbc.Driver");
        dsc.setUsername("root");
        dsc.setPassword("root");
        mpg.setDataSource(dsc);

        // åŒ…é…ç½®
        PackageConfig pc = new PackageConfig();
        pc.setModuleName(scanner("vhr"));
        pc.setParent("com.mycode");
        mpg.setPackageInfo(pc);

        // è‡ªå®šä¹‰é…ç½®
        InjectionConfig cfg = new InjectionConfig() {
            @Override
            public void initMap() {
                // to do nothing
            }
        };

        // å¦‚æœæ¨¡æ¿å¼•æ“æ˜¯ freemarker
        String templatePath = "/templates/mapper.xml.ftl";
        // å¦‚æœæ¨¡æ¿å¼•æ“æ˜¯ velocity
        // String templatePath = "/templates/mapper.xml.vm";

        // è‡ªå®šä¹‰è¾“å‡ºé…ç½®
        List<FileOutConfig> focList = new ArrayList<>();
        // è‡ªå®šä¹‰é…ç½®ä¼šè¢«ä¼˜å…ˆè¾“å‡º
        focList.add(new FileOutConfig(templatePath) {
            @Override
            public String outputFile(TableInfo tableInfo) {
                // è‡ªå®šä¹‰è¾“å‡ºæ–‡ä»¶å ï¼Œ å¦‚æœä½  Entity è®¾ç½®äº†å‰åç¼€ã€æ­¤å¤„æ³¨æ„ xml çš„åç§°ä¼šè·Ÿç€å‘ç”Ÿå˜åŒ–ï¼ï¼
                return projectPath + "/src/main/resources/mapper/" + pc.getModuleName()
                        + "/" + tableInfo.getEntityName() + "Mapper" + StringPool.DOT_XML;
            }
        });
        /*
        cfg.setFileCreate(new IFileCreate() {
            @Override
            public boolean isCreate(ConfigBuilder configBuilder, FileType fileType, String filePath) {
                // åˆ¤æ–­è‡ªå®šä¹‰æ–‡ä»¶å¤¹æ˜¯å¦éœ€è¦åˆ›å»º
                checkDir("è°ƒç”¨é»˜è®¤æ–¹æ³•åˆ›å»ºçš„ç›®å½•ï¼Œè‡ªå®šä¹‰ç›®å½•ç”¨");
                if (fileType == FileType.MAPPER) {
                    // å·²ç»ç”Ÿæˆ mapper æ–‡ä»¶åˆ¤æ–­å­˜åœ¨ï¼Œä¸æƒ³é‡æ–°ç”Ÿæˆè¿”å› false
                    return !new File(filePath).exists();
                }
                // å…è®¸ç”Ÿæˆæ¨¡æ¿æ–‡ä»¶
                return true;
            }
        });
        */
        cfg.setFileOutConfigList(focList);
        mpg.setCfg(cfg);

        // é…ç½®æ¨¡æ¿
        TemplateConfig templateConfig = new TemplateConfig();

        // é…ç½®è‡ªå®šä¹‰è¾“å‡ºæ¨¡æ¿
        //æŒ‡å®šè‡ªå®šä¹‰æ¨¡æ¿è·¯å¾„ï¼Œæ³¨æ„ä¸è¦å¸¦ä¸Š.ftl/.vm, ä¼šæ ¹æ®ä½¿ç”¨çš„æ¨¡æ¿å¼•æ“è‡ªåŠ¨è¯†åˆ«
        // templateConfig.setEntity("templates/entity2.java");
        // templateConfig.setService();
        // templateConfig.setController();

        templateConfig.setXml(null);
        mpg.setTemplate(templateConfig);

        // ç­–ç•¥é…ç½®
        StrategyConfig strategy = new StrategyConfig();
        strategy.setNaming(NamingStrategy.underline_to_camel);
        strategy.setColumnNaming(NamingStrategy.underline_to_camel);
        strategy.setSuperEntityClass("");
        strategy.setEntityLombokModel(true);
        strategy.setRestControllerStyle(true);
        // å…¬å…±çˆ¶ç±»
        strategy.setSuperControllerClass("");
        // å†™äºçˆ¶ç±»ä¸­çš„å…¬å…±å­—æ®µ
        strategy.setSuperEntityColumns("id");
        strategy.setInclude(scanner("è¡¨åï¼Œå¤šä¸ªè‹±æ–‡é€—å·åˆ†å‰²").split(","));
        strategy.setControllerMappingHyphenStyle(true);
        strategy.setTablePrefix(pc.getModuleName() + "_");
        mpg.setStrategy(strategy);
        mpg.setTemplateEngine(new FreemarkerTemplateEngine());
        mpg.execute();
    }

}
```



# æºç é˜…è¯»

## mybatis å­—æ®µç­–ç•¥

å‚è€ƒï¼š[MyBatis-Plus é…ç½® field-strategy å±æ€§è¯¦è§£](https://www.lichenliang.top/2019/03/mybatis-plus-global-config-field-strategy.html)

æ€è€ƒï¼šmybatiså¦‚ä½•æ’å…¥ä¸€ä¸ªnull,æˆ–è€…å¦‚ä½•å®ç°å¦‚æœæ’å…¥çš„æ—¶å€™å¿½ç•¥æ‰nullå€¼ã€‚

MyBatis-Plus åœ¨ SpringBoot çš„ä¸­æœ‰ä¸ªé…ç½®é¡¹ field-strategy ã€‚å®˜æ–¹è¯´æ˜å¦‚ä¸‹ï¼š

> è¯¥ç­–ç•¥çº¦å®šäº†å¦‚ä½•äº§å‡ºæ³¨å…¥çš„sql,æ¶‰åŠ`insert`,`update`ä»¥åŠ`wrapper`å†…éƒ¨çš„`entity`å±æ€§ç”Ÿæˆçš„ where æ¡ä»¶

åœ¨ä¸‹é¢è¿™ä¸ªåŒ…ä¸­è‡ªåŠ¨è®¾ç½®äº†field-strategy

```java
package com.baomidou.mybatisplus.enums;
```

```java
package com.baomidou.mybatisplus.enums;

/**
 * <p>
 * å­—æ®µç­–ç•¥æšä¸¾ç±»
 * </p>
 *
 * @author hubin
 * @Date 2016-09-09
 */
public enum FieldStrategy {
    IGNORED(0, "å¿½ç•¥åˆ¤æ–­"),
    NOT_NULL(1, "é NULL åˆ¤æ–­"),
    NOT_EMPTY(2, "éç©ºåˆ¤æ–­");
    /**
     * ä¸»é”®
     */
    private final int key;
    /**
     * æè¿°
     */
    private final String desc;
    FieldStrategy(final int key, final String desc) {
        this.key = key;
        this.desc = desc;
    }
    //é‡ç‚¹æ ¹æ®ä¸åŒçš„keyè¿›è¡Œé€‰æ‹©ç­–ç•¥ï¼šå¿½ç•¥åˆ¤æ–­ã€é NULL åˆ¤æ–­ã€éç©ºåˆ¤æ–­
    //é»˜è®¤æ˜¯é NULL åˆ¤æ–­
    //å¯ä»¥åœ¨ç±»ä¸Šé¢åŠ strategyï¼Œä¾‹å­å¦‚ä¸‹é¢
    //@TableField(value = "user_name", strategy = FieldStrategy.IGNORED)
	//private String userName;
    public static FieldStrategy getFieldStrategy(int key) {
        FieldStrategy[] fss = FieldStrategy.values();
        for (FieldStrategy fs : fss) {
            if (fs.getKey() == key) {
                return fs;
            }
        }
        return FieldStrategy.NOT_NULL;
    }
    public int getKey() {
        return this.key;
    }
    public String getDesc() {
        return this.desc;
    }
}
```

å…³æ³¨è¿™ä¸ªå¯ä»¥å‘ç°å¾ˆå¤šä¸œè¥¿

![image-20210129201001353](https://gitee.com/danmoqi/pictureBed/raw/master/img/image-20210129201001353.png)



